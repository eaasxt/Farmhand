#!/usr/bin/env python3
"""
Farmhand Dispatcher - Idle Agent Detector
Part of Phase 4.1: Automated Work Dispatcher

Displays agent activity status based on last_active_ts from MCP Agent Mail.
Agents idle >5 minutes are marked IDLE; otherwise ACTIVE.

Usage:
    farmhand-dispatcher [--json] [--help]

Options:
    --json    Output in JSON format for scripting
    --help    Show this help message
"""

import argparse
import sys
from pathlib import Path
from datetime import datetime, timezone

# Add parent directory to path for lib imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from lib.mcp_client import MCPClient, get_project_key
except ImportError:
    print("Error: Could not import lib.mcp_client. Run from project root or ensure lib/ is accessible.", file=sys.stderr)
    sys.exit(1)

# Threshold for idle detection (seconds)
IDLE_THRESHOLD = 300  # 5 minutes

def parse_iso_time(ts_str):
    """Parse ISO timestamp string to datetime object."""
    if not ts_str:
        return None
    try:
        # Handle Python < 3.11 fromisoformat limited support for 'Z'
        if ts_str.endswith('Z'):
            ts_str = ts_str[:-1] + '+00:00'
        return datetime.fromisoformat(ts_str)
    except ValueError:
        return None

def format_idle_time(total_seconds: int) -> str:
    """Format seconds into human-readable idle time."""
    if total_seconds < 60:
        return f"{total_seconds}s"
    elif total_seconds < 3600:
        return f"{total_seconds // 60}m"
    else:
        hours = total_seconds // 3600
        mins = (total_seconds % 3600) // 60
        return f"{hours}h {mins}m"


def get_agent_status(last_active_ts: str, now: datetime) -> dict:
    """
    Determine agent status based on last activity.

    Returns dict with: status, idle_seconds, idle_str
    """
    last_active_dt = parse_iso_time(last_active_ts)

    if not last_active_dt:
        return {"status": "NEVER", "idle_seconds": None, "idle_str": "N/A"}

    delta = now - last_active_dt
    total_seconds = int(delta.total_seconds())

    if total_seconds > IDLE_THRESHOLD:
        status = "IDLE"
    else:
        status = "ACTIVE"

    return {
        "status": status,
        "idle_seconds": total_seconds,
        "idle_str": format_idle_time(total_seconds)
    }


def main():
    parser = argparse.ArgumentParser(
        description="Farmhand Dispatcher - Idle Agent Detector",
        epilog="Part of Phase 4.1: Automated Work Dispatcher"
    )
    parser.add_argument(
        "--json",
        action="store_true",
        help="Output in JSON format for scripting"
    )
    parser.add_argument(
        "--project",
        type=str,
        default=None,
        help="Project key (default: current git repo or cwd)"
    )
    args = parser.parse_args()

    client = MCPClient()

    if not client.health_check():
        if args.json:
            import json
            print(json.dumps({"error": "MCP Agent Mail service not responding"}))
        else:
            print("Error: MCP Agent Mail service is not responding.", file=sys.stderr)
        sys.exit(1)

    project_key = args.project or get_project_key()
    agents = client.list_agents(project_key)

    if not agents:
        if args.json:
            import json
            print(json.dumps({"project": project_key, "agents": []}))
        else:
            print(f"No agents found for project: {project_key}")
        return

    now = datetime.now(timezone.utc)

    results = []
    for agent in agents:
        name = agent.get("name", "Unknown")
        last_active = agent.get("last_active_ts")
        status_info = get_agent_status(last_active, now)

        results.append({
            "name": name,
            "status": status_info["status"],
            "idle_seconds": status_info["idle_seconds"],
            "idle_str": status_info["idle_str"],
            "last_active": last_active or "Never",
            "program": agent.get("program"),
            "task": agent.get("task_description", "")
        })

    if args.json:
        import json
        print(json.dumps({
            "project": project_key,
            "threshold_seconds": IDLE_THRESHOLD,
            "agents": results
        }, indent=2))
    else:
        print(f"{'AGENT':<20} {'STATUS':<10} {'IDLE TIME':<15} {'LAST ACTIVE':<25}")
        print("-" * 70)
        for r in results:
            print(f"{r['name']:<20} {r['status']:<10} {r['idle_str']:<15} {r['last_active']:<25}")


if __name__ == "__main__":
    main()
