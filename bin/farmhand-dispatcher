#!/usr/bin/env python3
"""
Farmhand Dispatcher - Idle Agent Detector
Part of Phase 4.1: Automated Work Dispatcher

DEPRECATED / NOT IN SCOPE (December 2025)
==========================================
This component is not currently in scope for development.
The dispatcher/automated work assignment feature has been deferred.

This file is retained for reference but should not be relied upon
or extended until the feature is officially prioritized.

Related beads (all closed, archived):
- Farmhand-5cx: Implement Phase 4.1a: Idle Agent Detection
- Farmhand-nss: Flesh out Dispatcher Planning Document
- Farmhand-i1h: Archive dispatcher component
"""

import sys
import json
import time
from pathlib import Path
from datetime import datetime, timezone, timedelta

# Add parent directory to path for lib imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from lib.mcp_client import MCPClient, get_project_key
except ImportError:
    print("Error: Could not import lib.mcp_client. Run from project root or ensure lib/ is accessible.", file=sys.stderr)
    sys.exit(1)

def parse_iso_time(ts_str):
    """Parse ISO timestamp string to datetime object."""
    if not ts_str:
        return None
    try:
        # Handle Python < 3.11 fromisoformat limited support for 'Z'
        if ts_str.endswith('Z'):
            ts_str = ts_str[:-1] + '+00:00'
        return datetime.fromisoformat(ts_str)
    except ValueError:
        return None

def main():
    client = MCPClient()
    
    if not client.health_check():
        print("Error: MCP Agent Mail service is not responding.", file=sys.stderr)
        sys.exit(1)

    project_key = get_project_key()
    agents = client.list_agents(project_key)
    
    if not agents:
        print(f"No agents found for project: {project_key}")
        return

    now = datetime.now(timezone.utc)
    
    print(f"{'AGENT':<20} {'STATUS':<10} {'IDLE TIME':<15} {'LAST ACTIVE':<25}")
    print("-" * 70)

    for agent in agents:
        name = agent.get("name", "Unknown")
        last_active = agent.get("last_active_ts")
        
        status = "UNKNOWN"
        idle_str = "N/A"
        
        last_active_dt = parse_iso_time(last_active)
        
        if last_active_dt:
            delta = now - last_active_dt
            total_seconds = int(delta.total_seconds())
            
            # Simple logic: > 5 mins = IDLE
            if total_seconds > 300:
                status = "IDLE"
            else:
                status = "ACTIVE"
                
            # Format idle time
            if total_seconds < 60:
                idle_str = f"{total_seconds}s"
            elif total_seconds < 3600:
                idle_str = f"{total_seconds // 60}m"
            else:
                idle_str = f"{total_seconds // 3600}h {(total_seconds % 3600) // 60}m"
        else:
             status = "NEVER"

        print(f"{name:<20} {status:<10} {idle_str:<15} {last_active or 'Never':<25}")

if __name__ == "__main__":
    main()
