#!/usr/bin/env python3
"""
Agent Cleanup Script
--------------------
Removes stale agents from MCP Agent Mail database and cleans up orphaned reservations.

Usage:
    agent-cleanup              # Interactive - show what would be cleaned
    agent-cleanup --force      # Actually delete stale agents
    agent-cleanup --hours 4    # Set staleness threshold (default: 2 hours)
    agent-cleanup --cron       # Non-interactive mode for cron jobs
"""

import argparse
import json
import os
import sqlite3
import sys
import time
from datetime import datetime, timedelta
from pathlib import Path

MCP_DB = Path.home() / "mcp_agent_mail" / "storage.sqlite3"
# Note: Reservations are now stored in SQLite, not JSON files


def get_stale_agents(conn, hours):
    """Get agents that haven't been active in the specified hours."""
    cursor = conn.cursor()
    
    # Get all agents with their last activity
    cursor.execute("""
        SELECT a.id, a.name, p.slug as project, a.program, a.model, 
               datetime(a.last_active_ts) as last_active,
               datetime(a.inception_ts) as registered
        FROM agents a
        JOIN projects p ON a.project_id = p.id
        ORDER BY a.last_active_ts DESC
    """)
    
    all_agents = cursor.fetchall()
    
    # Calculate threshold
    threshold = datetime.utcnow() - timedelta(hours=hours)
    threshold_str = threshold.strftime('%Y-%m-%d %H:%M:%S')
    
    # Get stale agents
    cursor.execute("""
        SELECT a.id, a.name, p.slug as project, a.program, a.model,
               datetime(a.last_active_ts) as last_active
        FROM agents a
        JOIN projects p ON a.project_id = p.id
        WHERE a.last_active_ts < ?
    """, (threshold_str,))
    
    stale = cursor.fetchall()
    
    return all_agents, stale, threshold


def get_orphaned_reservations(conn, hours):
    """Find reservations in SQLite that are expired or stale."""
    orphaned = []
    cursor = conn.cursor()

    now = datetime.utcnow()
    now_str = now.strftime('%Y-%m-%d %H:%M:%S')
    threshold = now - timedelta(hours=hours)
    threshold_str = threshold.strftime('%Y-%m-%d %H:%M:%S')

    # Get all non-released reservations that are either expired or stale
    cursor.execute("""
        SELECT
            fr.id,
            fr.path_pattern,
            fr.reason,
            fr.created_ts,
            fr.expires_ts,
            a.name as agent_name
        FROM file_reservations fr
        JOIN agents a ON fr.agent_id = a.id
        WHERE fr.released_ts IS NULL
          AND (fr.expires_ts < ? OR fr.created_ts < ?)
        ORDER BY fr.created_ts DESC
    """, (now_str, threshold_str))

    for row in cursor.fetchall():
        try:
            created_at = datetime.fromisoformat(row[3].replace('Z', '+00:00')) if row[3] else now
            expires_at = datetime.fromisoformat(row[4].replace('Z', '+00:00')) if row[4] else now

            # Handle timezone-naive datetimes
            if created_at.tzinfo:
                created_at = created_at.replace(tzinfo=None)
            if expires_at.tzinfo:
                expires_at = expires_at.replace(tzinfo=None)

            is_expired = expires_at < now
            age_hours = (now - created_at).total_seconds() / 3600

            orphaned.append({
                "id": row[0],
                "agent": row[5],
                "paths": [row[1]],
                "reason": "expired" if is_expired else "stale",
                "age_hours": round(age_hours, 1)
            })
        except (ValueError, AttributeError):
            orphaned.append({
                "id": row[0],
                "agent": row[5] or "unknown",
                "paths": [row[1]] if row[1] else [],
                "reason": "corrupted",
                "age_hours": None
            })

    return orphaned


def delete_stale_agents(conn, stale_agents):
    """Delete stale agents from the database."""
    cursor = conn.cursor()
    deleted = 0
    
    for agent in stale_agents:
        agent_id = agent[0]
        agent_name = agent[1]
        try:
            cursor.execute("DELETE FROM agents WHERE id = ?", (agent_id,))
            deleted += 1
            print(f"  Deleted: {agent_name}")
        except sqlite3.Error as e:
            print(f"  Error deleting {agent_name}: {e}")
    
    conn.commit()
    return deleted


def delete_orphaned_reservations(conn, orphaned):
    """Release orphaned reservations in the database."""
    cursor = conn.cursor()
    released = 0
    now_str = datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S.%f')

    for item in orphaned:
        try:
            cursor.execute(
                "UPDATE file_reservations SET released_ts = ? WHERE id = ?",
                (now_str, item["id"])
            )
            released += 1
            print(f"  Released: {item['agent']} - {item['paths'][0] if item['paths'] else 'unknown'} ({item['reason']})")
        except sqlite3.Error as e:
            print(f"  Error releasing reservation {item['id']}: {e}")

    conn.commit()
    return released


def main():
    parser = argparse.ArgumentParser(description="Clean up stale agents and orphaned reservations")
    parser.add_argument("--force", action="store_true", help="Actually delete (default: dry run)")
    parser.add_argument("--hours", type=float, default=2.0, help="Staleness threshold in hours (default: 2)")
    parser.add_argument("--cron", action="store_true", help="Non-interactive mode for cron jobs")
    args = parser.parse_args()
    
    if not MCP_DB.exists():
        print(f"MCP database not found: {MCP_DB}")
        sys.exit(1)
    
    try:
        conn = sqlite3.connect(str(MCP_DB))
    except sqlite3.Error as e:
        print(f"Failed to connect to database: {e}")
        sys.exit(1)
    
    # Get data
    all_agents, stale_agents, threshold = get_stale_agents(conn, args.hours)
    orphaned_reservations = get_orphaned_reservations(conn, args.hours)
    
    # Summary
    if not args.cron:
        print(f"\n{'='*60}")
        print(f"AGENT CLEANUP - Threshold: {args.hours} hours")
        print(f"{'='*60}")
        print(f"\nTotal agents in database: {len(all_agents)}")
        print(f"Stale agents (>{args.hours}h inactive): {len(stale_agents)}")
        print(f"Orphaned reservations: {len(orphaned_reservations)}")
        
        if all_agents:
            print(f"\nAll registered agents:")
            for agent in all_agents[:10]:  # Show first 10
                print(f"  - {agent[1]} ({agent[3]}) last active: {agent[5]}")
            if len(all_agents) > 10:
                print(f"  ... and {len(all_agents) - 10} more")
        
        if stale_agents:
            print(f"\nStale agents to remove:")
            for agent in stale_agents:
                print(f"  - {agent[1]} ({agent[3]}) last active: {agent[5]}")
        
        if orphaned_reservations:
            print(f"\nOrphaned reservations to remove:")
            for item in orphaned_reservations[:5]:
                print(f"  - {item['agent']}: {item['paths'][:2]} ({item['reason']}, {item['age_hours']}h)")
            if len(orphaned_reservations) > 5:
                print(f"  ... and {len(orphaned_reservations) - 5} more")
    
    # Execute cleanup
    if args.force:
        print(f"\n{'='*60}")
        print("EXECUTING CLEANUP")
        print(f"{'='*60}")
        
        if stale_agents:
            print("\nDeleting stale agents:")
            deleted_agents = delete_stale_agents(conn, stale_agents)
            print(f"  Total deleted: {deleted_agents}")
        
        if orphaned_reservations:
            print("\nReleasing orphaned reservations:")
            released_res = delete_orphaned_reservations(conn, orphaned_reservations)
            print(f"  Total released: {released_res}")
        
        if args.cron:
            # Cron mode: minimal output
            if stale_agents or orphaned_reservations:
                print(f"Cleaned: {len(stale_agents)} agents, {len(orphaned_reservations)} reservations")
        else:
            print("\nCleanup complete!")
    else:
        if not args.cron:
            print(f"\n{'='*60}")
            print("DRY RUN - No changes made")
            print("Run with --force to actually delete")
            print(f"{'='*60}")
        
        # Exit code indicates if cleanup is needed
        if stale_agents or orphaned_reservations:
            sys.exit(1)  # Cleanup needed
    
    conn.close()
    sys.exit(0)


if __name__ == "__main__":
    main()
