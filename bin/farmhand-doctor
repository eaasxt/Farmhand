#!/usr/bin/env python3
"""
Farmhand Doctor
---------------
A diagnostic tool to check the health of the Farmhand multi-agent environment.

Checks:
1. Agent Registration
2. MCP Agent Mail Service
3. Enforcement Hooks
4. Beads (bd) Installation
5. Disk Space
6. Git Status

Usage:
    farmhand-doctor
"""

import os
import sys
import shutil
import subprocess
import json
from pathlib import Path

# Colors for output
GREEN = "\033[0;32m"
RED = "\033[0;31m"
YELLOW = "\033[1;33m"
NC = "\033[0m" # No Color

def print_check(name, status, message=""):
    if status == "ok":
        print(f"{GREEN}[OK]{NC} {name}")
    elif status == "fail":
        print(f"{RED}[FAIL]{NC} {name}")
        if message:
            print(f"      {message}")
    elif status == "warn":
        print(f"{YELLOW}[WARN]{NC} {name}")
        if message:
            print(f"      {message}")

def check_registration():
    home = Path.home()
    claude_dir = home / ".claude"
    
    # Check for legacy single-agent state
    legacy_state = claude_dir / "agent-state.json"
    
    # Check for multi-agent state (state-*.json)
    multi_states = list(claude_dir.glob("state-*.json"))
    
    if multi_states:
        return "ok", f"Found {len(multi_states)} registered agent(s)"
    elif legacy_state.exists():
        try:
            with open(legacy_state) as f:
                data = json.load(f)
                if data.get("registered"):
                    return "ok", f"Registered as {data.get('agent_name')}"
        except:
            pass

    # Fallback: Check SQLite DB
    db_path = home / "mcp_agent_mail" / "storage.sqlite3"
    if db_path.exists():
        try:
            import sqlite3
            conn = sqlite3.connect(str(db_path))
            cursor = conn.cursor()
            cursor.execute("SELECT count(*) FROM agents")
            count = cursor.fetchone()[0]
            conn.close()
            if count > 0:
                return "warn", f"Found {count} agent(s) in DB, but local state file is unregistered (try 'register_agent()' to fix local state)"
        except Exception as e:
            return "fail", f"DB check failed: {e}"
            
    return "fail", "No registered agent found. Run 'register_agent()' via Claude."

def check_mcp_service():
    # 1. Systemd check
    try:
        result = subprocess.run(
            ["systemctl", "is-active", "mcp-agent-mail"], 
            capture_output=True, 
            text=True
        )
        if result.returncode != 0:
            return "fail", f"Service is {result.stdout.strip() or 'inactive'}"
    except FileNotFoundError:
        pass # proceed to http check if systemctl missing (e.g. docker)

    # 2. HTTP API check
    import urllib.request
    import urllib.error
    
    url = "http://127.0.0.1:8765/mcp/"
    payload = {
        "jsonrpc": "2.0", 
        "method": "tools/call", 
        "params": {"name": "health_check", "arguments": {}}, 
        "id": 1
    }
    
    try:
        req = urllib.request.Request(
            url, 
            data=json.dumps(payload).encode('utf-8'), 
            headers={'Content-Type': 'application/json'}
        )
        with urllib.request.urlopen(req, timeout=2) as response:
            if response.status == 200:
                body = json.loads(response.read().decode('utf-8'))
                if "error" in body:
                    return "fail", f"API Error: {body['error']['message']}"
                return "ok", "Service active and responding to API"
            else:
                return "fail", f"API HTTP {response.status}"
    except Exception as e:
        return "fail", f"API check failed: {e}"

def check_ollama():
    # 1. Systemd check
    try:
        result = subprocess.run(
            ["systemctl", "is-active", "ollama"], 
            capture_output=True, 
            text=True
        )
        if result.returncode != 0:
            return "fail", f"Service is {result.stdout.strip() or 'inactive'}"
    except FileNotFoundError:
        pass

    # 2. API check
    import urllib.request
    import urllib.error
    
    url = "http://localhost:11434/api/version"
    try:
        with urllib.request.urlopen(url, timeout=2) as response:
            if response.status == 200:
                data = json.loads(response.read().decode('utf-8'))
                version = data.get('version', 'unknown')
                return "ok", f"Service active (version {version})"
            else:
                return "fail", f"API HTTP {response.status}"
    except Exception as e:
        return "fail", f"API check failed: {e}"

def check_hooks():
    hooks_dir = Path.home() / ".claude" / "hooks"
    if not hooks_dir.exists():
        return "fail", f"Hooks directory missing: {hooks_dir}"
        
    required_hooks = [
        "reservation-checker.py",
        "mcp-state-tracker.py", 
        "todowrite-interceptor.py",
        "git_safety_guard.py"
    ]
    
    missing = []
    for hook in required_hooks:
        if not (hooks_dir / hook).exists():
            missing.append(hook)
            
    if missing:
        return "fail", f"Missing hooks: {', '.join(missing)}"
        
    return "ok", "All core hooks installed"

def check_beads():
    try:
        result = subprocess.run(
            ["bd", "--version"], 
            capture_output=True, 
            text=True
        )
        if result.returncode == 0:
            return "ok", result.stdout.strip()
        else:
            return "fail", "bd command failed"
    except FileNotFoundError:
        return "fail", "bd command not found in PATH"

def check_disk_space():
    total, used, free = shutil.disk_usage("/")
    free_gb = free // (2**30)
    
    if free_gb < 2:
        return "fail", f"Critical low disk space: {free_gb}GB free"
    elif free_gb < 10:
        return "warn", f"Low disk space: {free_gb}GB free"
    else:
        return "ok", f"{free_gb}GB free"

def check_git_status():
    try:
        # Check if inside git repo
        subprocess.run(
            ["git", "rev-parse", "--is-inside-work-tree"], 
            check=True, 
            capture_output=True
        )
        
        # Check for uncommitted changes
        result = subprocess.run(
            ["git", "status", "--porcelain"], 
            capture_output=True, 
            text=True
        )
        
        if result.stdout.strip():
            return "warn", "Uncommitted changes detected"
        else:
            return "ok", "Working tree clean"
            
    except subprocess.CalledProcessError:
        return "fail", "Not a git repository"

def main():
    print(f"\n{YELLOW}Farmhand Doctor{NC} - System Diagnostic\n")
    
    checks = [
        ("Registration", check_registration),
        ("MCP Service", check_mcp_service),
        ("Ollama", check_ollama),
        ("Hooks", check_hooks),
        ("Beads (Task Tracking)", check_beads),
        ("Disk Space", check_disk_space),
        ("Git Status", check_git_status)
    ]
    
    for name, func in checks:
        status, message = func()
        print_check(name, status, message)
        
    print("\nDiagnostic complete.")

if __name__ == "__main__":
    main()
