# Farmhand Bugfixes - December 28, 2025

This document details critical bugs discovered and fixed during a multi-agent debugging session.

## Summary

| Bug | Severity | Impact | Status |
|-----|----------|--------|--------|
| Timestamp format mismatch in reservation-checker | Critical | ALL file reservations broken | Fixed |
| PostToolUse hook not parsing MCP responses | Critical | Agent registration never saved | Fixed |
| NTM config missing AGENT_NAME for Codex/Gemini | High | Multi-agent state conflicts | Fixed |
| Session resume preserves stale AGENT_NAME | Low | Known limitation | Documented |

---

## Bug 1: Timestamp Format Mismatch in reservation-checker.py

### Symptoms
- File reservations appeared to not exist even after calling `file_reservation_paths()`
- Hooks always blocked edits with "File not reserved" even though reservations were in database
- All agents affected

### Root Cause
The `reservation-checker.py` hook used Python's `datetime.isoformat()` to generate timestamps for SQL comparison:

```python
# BROKEN: ISO format with 'T' separator
now = datetime.now(timezone.utc).isoformat()
# Produces: "2025-12-28T03:08:12.392479+00:00"
```

But MCP Agent Mail stores timestamps in SQLite with space separator:
```
# Database format
"2025-12-28 03:08:12.392479"
```

SQLite string comparison: `' '` (ASCII 32) < `'T'` (ASCII 84), so the database timestamp always appeared "less than" the current time, making all reservations look expired.

### Fix
**File:** `hooks/reservation-checker.py:155-158`

```python
# FIXED: Use space-separated format to match SQLite storage
now = datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S.%f')
# Produces: "2025-12-28 03:08:12.392479"
```

### Verification
```python
# Before fix: Query returns no results
# After fix: Query correctly returns active reservations
sqlite3 ~/mcp_agent_mail/storage.sqlite3 \
  "SELECT * FROM file_reservations WHERE expires_ts > '2025-12-28 03:08:12'"
```

---

## Bug 2: PostToolUse Hook Not Parsing MCP Tool Responses

### Symptoms
- `register_agent()` returned successfully but state file showed `registered: false`
- Agent name not saved after registration
- Subsequent operations failed because agent appeared unregistered

### Root Cause
The `mcp-state-tracker.py` hook expected MCP tool output in a field called `tool_output`:

```python
# BROKEN: Wrong field name
tool_output = input_data.get("tool_output", {})
```

But Claude Code passes MCP responses as a **JSON string** in `tool_response`:

```json
{
  "tool_name": "mcp__mcp-agent-mail__register_agent",
  "tool_response": "{\"id\":40,\"name\":\"GreenCastle\",...}",
  "tool_output": {}
}
```

### Fix
**File:** `hooks/mcp-state-tracker.py:197-209`

```python
# FIXED: Parse tool_response as JSON string
tool_response_raw = input_data.get("tool_response", "")
if isinstance(tool_response_raw, str) and tool_response_raw:
    try:
        tool_output = json.loads(tool_response_raw)
    except json.JSONDecodeError:
        tool_output = {}
elif isinstance(tool_response_raw, dict):
    tool_output = tool_response_raw
else:
    tool_output = {}
```

### Verification
```bash
# Check state file after registration
cat ~/.claude/state-*.json | jq '.registered, .agent_name'
# Should show: true, "SomeAgentName"
```

---

## Bug 3: NTM Config Missing AGENT_NAME for Codex/Gemini

### Symptoms
- Claude agents got correct AGENT_NAME from pane title
- Codex and Gemini agents had no AGENT_NAME set
- Multi-agent state conflicts when Codex/Gemini tried to edit files

### Root Cause
The NTM config template only included AGENT_NAME extraction for Claude:

```toml
# BROKEN: Only claude had AGENT_NAME
[agents]
claude = "AGENT_NAME=\"$(tmux display-message -p '#{pane_title}')\" ..."
codex = "codex ..."  # No AGENT_NAME
gemini = "gemini ..." # No AGENT_NAME
```

### Fix
**File:** `config/ntm/config.toml`

```toml
# FIXED: All agents get AGENT_NAME from pane title
[agents]
claude = "AGENT_NAME=\"$(tmux display-message -p '#{pane_title}')\" ..."
codex = "AGENT_NAME=\"$(tmux display-message -p '#{pane_title}')\" ..."
gemini = "AGENT_NAME=\"$(tmux display-message -p '#{pane_title}')\" ..."
```

### Installation
The fix is applied automatically during `./scripts/install/08-shell-config.sh` or manually:
```bash
cp config/ntm/config.toml ~/.config/ntm/config.toml
sed -i "s|__HOME__|$HOME|g" ~/.config/ntm/config.toml
```

---

## Known Limitation: Session Resume Preserves Stale AGENT_NAME

### Symptoms
- After conversation continuation (session resume), AGENT_NAME may not match current pane title
- Example: AGENT_NAME=`Farmhand__gmi_1` but pane title is `Farmhand__cc_2`

### Root Cause
When Claude Code resumes a session from conversation context:
1. The original AGENT_NAME env var is preserved in the session state
2. Pane titles may have changed (panes reorganized, killed, recreated)
3. Env vars cannot be changed mid-process

### Workaround
For accurate AGENT_NAME, spawn a new session rather than resuming:
```bash
# Kill and respawn instead of resuming
ntm kill myproject
ntm spawn myproject --cc=2
```

### Status
This is an inherent limitation of environment variables, not a bug. New agent spawns work correctly.

---

## Additional Fixes

### Gemini Memory File Stale Name
**File:** `~/.gemini/GEMINI.md`

Gemini CLI stores persistent memories. A previous session saved a hardcoded agent name:
```markdown
## Gemini Added Memories
- My agent name is WhiteBear...
```

**Fix:** Updated to reference AGENT_NAME env var:
```markdown
## Gemini Added Memories
- My agent name comes from the AGENT_NAME environment variable.
```

---

## Testing Checklist

After applying fixes, verify:

1. **File Reservations Work**
   ```python
   file_reservation_paths(project_key="/home/ubuntu", agent_name="TestAgent",
                          paths=["test.py"], ttl_seconds=60, exclusive=True, reason="test")
   # Should succeed, and subsequent Edit/Write should work
   ```

2. **Registration Saves to State**
   ```python
   register_agent(project_key="/home/ubuntu", program="claude-code", model="opus-4.5")
   # Check: ~/.claude/state-*.json should show registered: true
   ```

3. **All Agent Types Get AGENT_NAME**
   ```bash
   # In each agent pane:
   echo $AGENT_NAME
   # Should match pane title (e.g., "Farmhand__cc_1")
   ```

---

## Files Changed

| File | Change |
|------|--------|
| `hooks/reservation-checker.py` | Fixed timestamp format for SQLite comparison |
| `hooks/mcp-state-tracker.py` | Fixed parsing of MCP tool_response as JSON string |
| `config/ntm/config.toml` | Added AGENT_NAME extraction for all agent types |

---

## Credits

Bugs discovered and fixed during collaborative debugging session between multiple Claude agents on December 28, 2025.
